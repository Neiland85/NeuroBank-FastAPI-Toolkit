version: "3.8"
services:
  zookeeper:
    image: bitnami/zookeeper:latest
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports: ["2181:2181"]

  kafka:
    image: bitnami/kafka:latest
    depends_on: [zookeeper]
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    ports: ["9092:9092"]

  api_gateway:
    build:
      context: .
      dockerfile: ./Dockerfile  # o el Dockerfile del servicio API si lo separas
    env_file: [.env]
    environment:
      ENVIRONMENT: "staging"
      KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
    ports: ["8000:8000"]
    command: >
      sh -c "uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers ${WORKERS:-1}"
    depends_on: [kafka]

  ingestion_service:
    build:
      context: ./trading_ai_system/ingestion_service
    env_file: [.env]
    environment:
      KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      TOPIC_MARKET_DATA: "market_data"
    depends_on: [kafka]

  inference_service:
    build:
      context: ./trading_ai_system/inference_service
    env_file: [.env]
    environment:
      KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      TOPIC_MARKET_DATA: "market_data"
      TOPIC_TRADE_SIGNALS: "trade_signals"
      OTEL_SERVICE_NAME: "inference_service"
    depends_on: [kafka]

  control_service:
    build:
      context: ./trading_ai_system/control_service
    env_file: [.env]
    environment:
      KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      TOPIC_TRADE_SIGNALS: "trade_signals"
    depends_on: [kafka]
