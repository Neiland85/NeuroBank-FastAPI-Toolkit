name: Deploy Staging (Railway)

on:
  # Solo ejecutable manualmente
  workflow_dispatch:
    inputs:
      confirm:
        description: "Confirmar deploy a Railway STAGING"
        required: true
        default: "no"
        type: choice
        options: ["no", "yes"]

concurrency:
  group: staging-railway
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Ejecutar solo si se invoca manualmente y hay token
    if: github.event_name == 'workflow_dispatch' && inputs.confirm == 'yes' && secrets.RAILWAY_TOKEN != ''
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node (Railway CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Auth
        run: railway login --token "$RAILWAY_TOKEN"

      # Si tienes railway.toml en la ra√≠z con todos los servicios:
      - name: Deploy API Gateway
        run: railway up --service api-gateway --yes

      - name: Deploy Ingestion
        run: railway up --service ingestion-service --yes

      - name: Deploy Inference
        run: railway up --service inference-service --yes

      - name: Deploy Control
        run: railway up --service control-service --yes

