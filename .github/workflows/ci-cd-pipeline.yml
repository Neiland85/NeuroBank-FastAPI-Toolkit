name: "üöÄ CI/CD Pipeline"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  POETRY_VERSION: '1.8.0'

jobs:
  code-quality:
    name: "üé® Code Quality"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt
      - name: Run Ruff (linting)
        run: ruff check app/ --output-format=github
      - name: Run Ruff (formatting check)
        run: ruff format --check app/
      - name: Run Radon (complexity)
        run: |
          radon cc app/ -a -s -j > radon-cc.json
          radon mi app/ -s -j > radon-mi.json
      - name: Run Vulture (dead code)
        run: vulture app/ --min-confidence 60 || true
      - name: Run Interrogate (docstring coverage)
        run: interrogate app/ --fail-under 80 || true
      - name: Upload complexity reports
        uses: actions/upload-artifact@v4
        with:
          name: complexity-reports
          path: radon-*.json

  type-checking:
    name: "üîç Type Checking"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements-dev.txt
      - name: Run MyPy
        run: mypy app/ --junit-xml mypy-report.xml
      - name: Upload MyPy report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mypy-report
          path: mypy-report.xml

  security:
    name: "üîí Security Scanning"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements-dev.txt
      - name: Run Bandit
        run: bandit -r app/ -c .bandit -f json -o bandit-report.json
      - name: Run Safety
        run: safety check --json > safety-report.json || true
      - name: Run pip-audit
        run: pip-audit --format json > pip-audit-report.json || true
      - name: Run Semgrep
        run: semgrep --config auto app/ --json > semgrep-report.json || true
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: '*-report.json'

  dependencies:
    name: "üì¶ Dependency Analysis"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements-dev.txt
      - name: Run pipdeptree
        run: pipdeptree --json > pipdeptree.json
      - name: Run deptry
        run: deptry app/ --json-output deptry-report.json || true
      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: '*tree*.json'

  test:
    name: "üß™ Testing"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      - name: Run pytest with coverage
        run: |
          pytest --cov=app --cov-report=xml --cov-report=html --cov-report=term-missing --junitxml=test-results.xml
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            test-results.xml
            htmlcov/

  sonarcloud:
    name: "üìä SonarCloud Analysis"
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results-3.11
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  docker:
    name: "üê≥ Docker Build"
    runs-on: ubuntu-latest
    needs: [code-quality, type-checking, security, test]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/neurobank-fastapi:latest
            ${{ secrets.DOCKER_USERNAME }}/neurobank-fastapi:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: "üöÇ Deploy to Railway"
    runs-on: ubuntu-latest
    needs: [docker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      - name: Deploy to Railway
        run: railway up --service neurobank-api
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

