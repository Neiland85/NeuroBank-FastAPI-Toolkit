name: CD - Deploy to Railway (Karpathy Mode)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      ####################################################################
      # 1. Install Railway CLI (ultra-stable deterministic reproducibility)
      ####################################################################
      - name: Install Railway CLI (Karpathy Hardened)
        run: |
          set -e
          echo "üîß Installing Railway CLI‚Ä¶"
          
          # Version pinning (Karpathy style: reproducible forever)
          RAILWAY_VERSION="3.11.1"

          # Primary download (GitHub Release)
          curl -L "https://github.com/railwayapp/cli/releases/download/v${RAILWAY_VERSION}/railway-linux-amd64" \
            -o railway || {
              echo "‚ö†Ô∏è Primary download failed, activating fallback mirror‚Ä¶"
              curl -L "https://railway-mirror.neurobank.dev/cli/v${RAILWAY_VERSION}/railway-linux-amd64" \
                -o railway
            }

          chmod +x railway
          sudo mv railway /usr/local/bin/railway

      ####################################################################
      # 2. Verify CLI installation (fail-fast philosophy)
      ####################################################################
      - name: Verify CLI
        run: |
          echo "üîç Checking Railway CLI version‚Ä¶"
          railway --version

      ####################################################################
      # 3. Deploy (stateless, deterministic, CI-safe)
      ####################################################################
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üöÄ Deploying NeuroBank to Railway‚Ä¶"
          railway up --ci --detach

      ####################################################################
      # 4. Post-deploy sanity check (Karpathy loves invariants)
      ####################################################################
      - name: Health Check
        continue-on-error: true
        run: |
          echo "üîé Running post-deploy health check‚Ä¶"
          curl -I https://neurobank-yourapp.railway.app || true

