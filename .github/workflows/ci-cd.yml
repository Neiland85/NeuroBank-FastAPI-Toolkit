name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

    inputs:
      deploy_to_aws:
        description: "Deploy to AWS?"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      environment:
        description: "Environment"
        required: true
        default: "staging"
        type: choice
        options:
          - "staging"
          - "production"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-west-1
  ECR_REPOSITORY: neurobank-fastapi
  AWS_ACCOUNT_ID: 120242956739
  AWS_ROLE_ARN: arn:aws:iam::120242956739:role/GitHubActionsOIDCRole

jobs:

  test:
    runs-on: ubuntu-latest
    env:
      CI: "true"
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest --cov=app --cov-report=xml --cov-report=html

      - uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage.xml

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install tools
        run: |
          pip install -r requirements.txt
          pip install bandit safety

      - name: Bandit
        run: bandit -r app/ -f json -o bandit-report.json --skip B101 || true

      - name: Safety
        run: |
          pip freeze > current-requirements.txt
          safety scan --json --output safety-report.json --continue-on-error || true

      - uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  deployment-check:
    needs: [test, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deployment readiness
        run: |
          echo "OK"

  build-and-deploy:
    needs: [test, security]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_aws == 'true'
    steps:
      - uses: actions/checkout@v6

      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - run: aws sts get-caller-identity

      - uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} || \
          aws ecr create-repository --repository-name ${{ env.ECR_REPOSITORY }}

      - uses: aws-actions/amazon-ecr-login@v2
        id: login-ecr

      - name: Build and push image
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          TAG: ${{ github.sha }}
        run: |
          docker build -t $REGISTRY/$ECR_REPOSITORY:$TAG .
          docker push $REGISTRY/$ECR_REPOSITORY:$TAG

      - name: Deploy
        run: |
          sam build
          sam deploy --no-confirm-changeset --no-fail-on-empty-changeset \
            --stack-name neurobank-api \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }}
